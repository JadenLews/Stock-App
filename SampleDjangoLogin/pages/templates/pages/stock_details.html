{% extends "base.html" %}

{% block page_content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/stock_details.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="content-container d-flex justify-content-between align-items-start">
    <!-- Left Section for Chart -->
    <div class="content-container color_me d-flex flex-wrap justify-content-between align-items-start">
        <!-- Buttons for Timeframe Selection -->
        <div class="button-container">
            <button class="timeframe-btn {% if time_frame == '1d' %}selected{% endif %}" onclick="window.location.href = '{% url 'stock_details_with_time_frame' symbol '1d' %}'">1D</button>
            <button class="timeframe-btn {% if time_frame == '5d' %}selected{% endif %}" onclick="window.location.href = '{% url 'stock_details_with_time_frame' symbol '5d' %}'">5D</button>
            <button class="timeframe-btn {% if time_frame == '1mo' %}selected{% endif %}" onclick="window.location.href = '{% url 'stock_details_with_time_frame' symbol '1mo' %}'">1M</button>
            <button class="timeframe-btn {% if time_frame == '3mo' %}selected{% endif %}" onclick="window.location.href = '{% url 'stock_details_with_time_frame' symbol '3mo' %}'">3M</button>
            <button class="timeframe-btn {% if time_frame == '6mo' %}selected{% endif %}" onclick="window.location.href = '{% url 'stock_details_with_time_frame' symbol '6mo' %}'">6M</button>
            <button class="timeframe-btn {% if time_frame == '1y' %}selected{% endif %}" onclick="window.location.href = '{% url 'stock_details_with_time_frame' symbol '1y' %}'">1Y</button>
            <button class="timeframe-btn {% if time_frame == '5y' %}selected{% endif %}" onclick="window.location.href = '{% url 'stock_details_with_time_frame' symbol '5y' %}'">5Y</button>
        </div>
        <form method="POST" action="{% url 'add_watchlist' %}">
            {% csrf_token %}
            <input type="hidden" name="stock_symbol" value="{{ stock.symbol }}">
            <button type="submit" class="addtowatch">Add to Watchlist</button>
        </form>
    
        <!-- Chart Section -->
        <div class="chart-container">
            <canvas id="stockChart"></canvas>
        </div>
    </div>

    <!-- Right Section for Form Card -->
    <div class="search_results" style="width: 300px; flex-shrink: 0;">
        {% if error %}
            <div class="alert alert-danger" role="alert">{{ error }}</div>
        {% else %}
            <div class="card mb-4 buy_sell">
                <div class="card-header">
                    <span id="buyAction" class="action-item buy">Buy</span>
                    <span id="sellAction" class="action-item sell">Sell</span>
                </div>
                <div class="card-body">
                    <div class="stock_symbol d-flex flex-column justify-content-center align-items-center">
                        <h1 class="stock-display stockticker">{{ stock.symbol|upper }}</h1>
                        <label class="labelcurrent stockdisplay2" for="currentPrice">Market Price:</label>
                        <h1 class="stock-display stockdisplay2">${{ stock.price|floatformat:2 }}</h1>
                    </div>

                    <form method="POST" action="{% url 'execute_trade' %}">
                        {% csrf_token %}
                        <input type="hidden" name="stock_symbol" value="{{ stock.symbol }}">
                        <input type="hidden" name="trade_action" id="tradeAction" value="buy">

                        <div class="quantity d-flex flex-column justify-content-center align-items-center">
                            <label for="quantity" class="form-label">Shares:</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1">
                        </div>

                        <div class="total_price d-flex flex-column justify-content-center align-items-center">
                            <label class="labelcurrent" for="totalPrice">Total Price:</label>
                            <input type="text" class="stock-display" id="totalPrice" value="${{ stock.price|floatformat:2 }}" readonly>
                        </div>

                        <button type="submit" class="custom-btn">Execute Trade</button>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
    const chartLabels = {{ dates|safe }};
    const chartData = {{ closing_prices|safe }};

    const ctx = document.getElementById('stockChart').getContext('2d');
    const stockChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: '{{ stock.company_name|upper }} Stock Price',
                data: chartData,
                borderColor: 'rgba(0, 136, 255, 0.8)',
                backgroundColor: 'rgba(0, 136, 255, 0.1)',
                fill: true,
                tension: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { 
                    title: { display: true, text: 'Date', color: '#cccccc' },  // Light gray for axis title
                    ticks: { color: '#cccccc' },  // Light gray for tick labels
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }  // Faint grid lines
                },
                y: { 
                    title: { display: true, text: 'Price (USD)', color: '#cccccc' },  // Light gray for axis title
                    ticks: { color: '#cccccc' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#cccccc',  // Light gray for legend text
                        font: { size: 14 }
                    }
                }
            }
        }
    });

    document.getElementById('quantity').addEventListener('input', function () {
        const quantity = parseFloat(this.value) || 0;
        const price = parseFloat("{{ stock.price }}");
        const totalPrice = quantity * price;
        document.getElementById('totalPrice').value = `$${totalPrice.toFixed(2)}`;
    });

    function toggleActiveAction(activeId, inactiveId) {
        document.getElementById(activeId).classList.add('active-action');
        document.getElementById(inactiveId).classList.remove('active-action');
    }

    document.getElementById('buyAction').addEventListener('click', function () {
        document.getElementById('tradeAction').value = 'buy';
        toggleActiveAction('buyAction', 'sellAction');
    });
    document.getElementById('sellAction').addEventListener('click', function () {
        document.getElementById('tradeAction').value = 'sell';
        toggleActiveAction('sellAction', 'buyAction');
    });
</script>

<style>
    .content-container {
        display: flex;
        justify-content: space-between;
        gap: 0px;
    }

    .search_results {
        width: 300px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .content-container {
            flex-direction: column;
            align-items: center;
        }

        .chart-container {
            width: 100%;
            padding-right: 0;
        }

        .search_results {
            width: 100%;
            margin-top: 20px;
        }
    }

/* Container for the buttons */
.button-container {
    display: flex;
    justify-content: flex-start;
    gap: 25px;
    margin-left: 45px;
    margin-top: 20px;
    height: auto;  /* Allow height to be dynamic based on content */
    box-sizing: border-box;
}

/* Styling for each button */
.timeframe-btn {
    padding: 8px 18px;
    background-color: #4c4c61;
    color: #ffffff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.9rem;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.timeframe-btn:hover {
    background-color: #4a4a5c;
    color: #00ff00;
    transform: scale(1.05);
}

.timeframe-btn.selected {
    outline: none;
    box-shadow: 0 0 5px #00ff00;
    background-color: #282c34; /* Example background for the selected button */
    color: #00ff00; /* Optional: Change text color for selected */
}

/* Chart container */
.chart-container {
    height: 100%;  
    max-height: 500px;
    overflow: hidden;
    display: flex;
    align-items: center; 
    padding: 0px 10px;
    box-sizing: border-box;
    margin: 0px;
    min-height: 400px;
}

.color_me {
    background-color: #3e3e50;  
    border-radius: 5px;
    margin: 15px;
}

/* Canvas styling for the chart */
#stockChart {
    width: 100% !important;  
    height: auto !important;  
    max-height: 100%;

}

</style>
{% endblock %}